<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/build/three.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/three@0.130.1/examples/js/loaders/GLTFLoader.js"></script>

	<style>
		body {
			margin: 0;
		}

		div {
            position: absolute;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

		#score {
			bottom: 10px;
		}
		#ballonratés {
			bottom: 50px;
		}
		#reaparition {
			bottom: 90px;
		}
		#speed {
			bottom: 130px;
		}
		#meilleurScore {
			bottom: 10px;
			right: 100px;
		}
	</style>

	<title>Document</title>
</head>

<body>
	<script type="module">

		/////////////////////////////
		//     CAMERA ET SCENE     //
		/////////////////////////////

		const scene = new THREE.Scene();
		scene.background = new THREE.Color(0xa0a0a0);

		let SCREEN_WIDTH = window.innerWidth;
		let SCREEN_HEIGHT = window.innerHeight;
		let ratioLargeurHauteur = SCREEN_WIDTH / SCREEN_HEIGHT;

		const camera = new THREE.PerspectiveCamera(75, ratioLargeurHauteur, 0.1, 1000);
		camera.position.z = 5;

		const renderer = new THREE.WebGLRenderer();
		renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
		document.body.appendChild(renderer.domElement);

		function onWindowResize() {
			console.log("Redimensionnement de la fenêtre");
			SCREEN_WIDTH = window.innerWidth;
			SCREEN_HEIGHT = window.innerHeight;
			ratioLargeurHauteur = SCREEN_WIDTH / SCREEN_HEIGHT;

			camera.aspect = ratioLargeurHauteur;
			camera.updateProjectionMatrix();

			renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
		}

		window.addEventListener("resize", onWindowResize)

		const dirLightIntensity = 5;
		const dirLight = new THREE.DirectionalLight({ color: 0xffffff }, dirLightIntensity);
		dirLight.position.set(0, 20, 50);
		scene.add(dirLight);

		//////////////////////////////
		//  INTERFACE ET VARIABLES  //
		//////////////////////////////

		function updateInterface() {
			document.getElementById('score').textContent = 'Score : ' + score;
			document.getElementById('ballonratés').textContent = 'Ballons ratés : ' + ballonsRates;
			document.getElementById('reaparition').textContent = 'Réapartion : ' + reaparition;
			document.getElementById('speed').textContent = 'Vitesse : ' + speed;
			document.getElementById('meilleurScore').textContent = 'Meilleur score : ' + localStorage.getItem('stockageScore');
		}

		const ballons = [];
		let ballonsRates = 0;
		let score = 0;
		let speed = 1;
		let reaparition = 2500;

		/////////////////////////////
		//         BALLONS         //
		/////////////////////////////

		var loader = new THREE.GLTFLoader();

		function createBalloon() {
			let lienBallon;

			// Choisi aléatoirement la couleur du ballon
			const couleursBallon = ['bleu', 'jaune', 'orange', 'rose', 'rouge', 'vert', 'violet']
			const couleurBallon = couleursBallon[Math.floor(Math.random() * couleursBallon.length)];

			switch (couleurBallon) {
				case 'bleu':
					lienBallon = 'ballon_bleu.glb';
					break;
				case 'jaune':
					lienBallon = 'ballon_jaune.glb';
					break;
				case 'orange':
					lienBallon = 'ballon_orange.glb';
					break;
				case 'rose':
					lienBallon = 'ballon_rose.glb';
					break;
				case 'rouge':
					lienBallon = 'ballon_rouge.glb';
					break;
				case 'vert':
					lienBallon = 'ballon_vert.glb';
					break;
				case 'violet':
					lienBallon = 'ballon_violet.glb';
					break;
			}

			loader.load(lienBallon, function (gltf) {
				var ballon = gltf.scene;
				scene.add(ballon);
				ballons.push(ballon);

				// Position du ballon en bas de l'écran, aléatoire en x (non responsif)
				var ballonPositionY = -5
				ballon.position.y = ballonPositionY;

				var ballonPositionX = Math.random() * 14 - 7;
				ballon.position.x = ballonPositionX;

				var targetPositionY = 3.8;
				var animationDuration = 5000;
				var animationStartTime = Date.now();

				// Fait bouger le ballon de bas en haut
				function animateBallon() {
					var now = Date.now();
					var elapsed = now - animationStartTime;
					var progress = elapsed / animationDuration;

					if (progress < 1) {
						ballon.position.y = ballonPositionY + (targetPositionY - ballonPositionY) * progress * speed;
						requestAnimationFrame(animateBallon);
					}

					// Vérifie si le ballon a atteint la position cible targetPositionY
					if (Math.abs(ballon.position.y - targetPositionY) < 0.1) {
						const index = ballons.indexOf(ballon);
						if (index === -1) {
							scene.remove(ballon);
						}
						else {
							ballonsRates++;
							console.log('Ballon ratés : ', ballonsRates);
							if (index !== -1) {
								ballons.splice(index, 1);
							}
							scene.remove(ballon);
						}
						updateInterface();
					}
				}

				animateBallon();
			}, undefined, function (error) {
				console.error(error);
			});
		}

		function createRandomBalloon() {
			if (ballonsRates < 5) {
				createBalloon();
				var nextBalloonDelay = Math.random() * reaparition;
				setTimeout(createRandomBalloon, nextBalloonDelay);
				updateInterface();
			}
			else {
				if (score > localStorage.getItem('stockageScore')) {
					localStorage.setItem('stockageScore', score);
				}
				
			}
		}

		createRandomBalloon();

		//////////////////////////////
		//        EVENTCLICK        //
		//////////////////////////////

		renderer.domElement.addEventListener('click', onMouseClick, false);

		// Code raycaster
		function onMouseClick(event) {
			const mouseX = (event.clientX / SCREEN_WIDTH) * 2 - 1;
			const mouseY = -(event.clientY / SCREEN_HEIGHT) * 2 + 1;

			const vector = new THREE.Vector3(mouseX, mouseY, 1);
			vector.unproject(camera);

			const raycaster = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

			const intersects = raycaster.intersectObjects(ballons, true);

			if (intersects.length > 0) {
				let clickedBalloon = intersects[0].object;
				let parent = clickedBalloon.parent;

				parent.remove(clickedBalloon);
				score += 1;
				console.log('Score : ', score);

				if (score % 10 === 0 && score !== 0) {
					console.log(score);
					reaparition -= 100;
					console.log(reaparition);
				}

				speed += 0.08;

				// Retirer le ballon de la liste des ballons
				const index = ballons.indexOf(parent);
				if (index !== -1) {
					ballons.splice(index, 1);
				}
				scene.remove(parent);
				scene.remove(clickedBalloon);

				parent = undefined;
				clickedBalloon = undefined;

				updateInterface();
			}
		}

		/////////////////////////////
		//          RENDU          //
		/////////////////////////////

		function animate() {
			requestAnimationFrame(animate);
			renderer.render(scene, camera);
		}

		animate();

	</script>

	<div id="score">Score : 0</div>
	<div id="meilleurScore">Meilleur score : 0</div>
	<div id="ballonratés">Ballons ratés : 0</div>
	<div id="reaparition">Réapartion : 0</div>
	<div id="speed">Vitesse : 0</div>
</body>

</html>